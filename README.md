# Insulin Calculator

A system that calculates the insulin required to compensate the blood glucose rise caused by a meal.



## System Modules

The system is a client - server system with multiple functional modules. The functionalities of the modules includes generating food segmentation mask, estimating volume and area of objects in depth map, calculating insulin dose with consideration of carbs intake and blood glucose measure, as well as mobile and server application.

### Food Segmentation Model

A segmentation model that generate a mask indicating food / not food for a given image. [U-Net](https://arxiv.org/abs/1505.04597) is used in this system, this network is trained on [Food201-MultiLabel](https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/44321.pdf). See [here](./food_segmentation_model/README.md) for module details.

### Food Volume Estimation

A module that estimate the food volume and top surface area with depth map and color image. This process is done by generating a volume map as well as an area map according to the depth map as well as camera intrinsics, the integrate their area according to food labels generated by segmentation model and separated by connected component detection algorithm. The food classification of each entity is done by calling [Food API](https://dev.caloriemama.ai). See [here](./inculin_calculator_server/fvolume/README.md) for module details.

### Food Density Library

A food density library that maps the food volume to food weight. This library only done for test use, thus only a small subset of all food's density is recorded. To make this project a fully usable commercial project, this library have to be huge. When building the library, the food volume is estimated by the Food Volume Estimation module. See [here](./inculin_calculator_server/fdensitylib/README.md) for module details.

### Insulin Dose Estimation

A module that calculates the insulin dose considering the intake food nutrition and personalized data. This module is not finished yet.

### Front End

An iOS application that runs on iPhones with True Depth camera. This module is capable for capturing the depth map and color image of food, submitting the result to the server, and handle the response. This application is done in Swift with Storyboard user interface. See [here](./insulin_calculator/README.md) for module details.

### Back End

A Flask HTTP server that handles the front end data and provides model response. The submitted data will be stored in the server if the user permits. See [here](./inculin_calculator_server/README.md) for module details.



## Possible Improvements

Here are some possible ways for improving the performance of this system. They are worth trying for the future work.

### Speed Improvements

- Try different semantic segmentation network for food segmentation, such as [DeepLab V3](https://github.com/tensorflow/models/tree/master/research/deeplab).
- Find better ways to extract depth map as JSON.
- Filtering entities that is too small to be a real food entity.
- Switch the segmentation mask generation to CoreML and run it on device.

### Accuracy Improvements

- Using algorithm that considers color image instead of simple connect domain detection.
- Correct depth map and color image distortion, see [here](https://developer.apple.com/documentation/avfoundation/avcameracalibrationdata) for the details.
- Compensating the device orientation bias by applying transformation to the point cloud.



## Copyright

This project is my bachelor thesis project at Massachusetts Institute of Technology (MIT), the user should not violate terms and conditions specified by [Inventions and Proprietary Information Agreement (IPIA)](https://tlo.mit.edu/learn-about-intellectual-property/ownership/inventions-and-proprietary-information-agreement-ipia) of MIT.

